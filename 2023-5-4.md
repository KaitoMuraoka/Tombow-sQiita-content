<!--
title: ã€Swiftã€‘JSONEncoderã§nilã‚’Nullã¨ã—ã¦ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹
tags:  Swift,JSON
private: true
-->

# è¨˜äº‹ã®èƒŒæ™¯
å…ˆæ—¥ã€APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã‚‹éš›ã€`Int?`å‹ã«nilã‚’å…¥ã‚Œã¦æŠ•ã’ãŸã¨ã“ã‚ã€ã†ã¾ãåæ˜ ã•ã‚Œãªã„ã¨ã„ã†å•é¡Œã«ã¶ã¡å½“ãŸã£ãŸã€‚

## èƒŒæ™¯ã®è©³ç´°èª¬æ˜
ä¸Šè¨˜ã®èª¬æ˜ã ã¨å°‘ã—ã‚ã‹ã‚Šã¥ã‚‰ã„ã¨æ€ã„ã€ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦èª¬æ˜ã™ã‚‹ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ãªJSONãƒ‡ãƒ¼ã‚¿ãŒã‚ã£ãŸã¨ã™ã‚‹ã€‚

```JSON:JSON
{
  "name" : "Ame",
  "age" : 18,
  "hobby" : "webåˆ¶ä½œ"
}
```

ã“ã®å ´åˆã€Swiftã®æ§‹é€ ä½“ã‹ã‚‰JSONãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›ã™ã‚‹ãŸã‚ã«ã¯å¯¾è±¡ã®æ§‹é€ ä½“ãŒ`Encodable`ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã¾ãŸã¯`Codable`ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«æº–æ‹ ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

ãã®ãŸã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ§‹é€ ä½“ã‚’ä½œæˆã™ã‚‹ã€‚

```swift:SampleEncode.swift
struct Person: Encodable {
    var name:String
    var age:Int?
    var hobby:String?
}
```

ã“ã“ã§ã€`age`ã¨`hobby`ã¯Nullã‚’è¨±å®¹ã™ã‚‹ã‚‚ã®ã¨ã—ãŸã€‚

ã“ã‚Œã‚‰ã‚’åŸºã«ã€Swiftã§JSONãƒ‡ãƒ¼ã‚¿ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹ã€‚JSONãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹ã«ã¯`JSONEncoder`ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
ãã®ãŸã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã™ã‚‹ã€‚

```diff_swift:SampleEncode.swift
struct Person: Encodable {
    var name:String
    var age:Int?
    var hobby:String?
}

+ let person = Person(name: "Ame", age: 21, hobby: "Watch TV")
+ 
+ let encoder = JSONEncoder()
+ 
+ // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’æŒ‡å®š
+ encoder.outputFormatting = .prettyPrinted
+ 
+ // ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
+ let jsonData = try encoder.+ encode(person)
+ 
+ // æ–‡å­—ã‚³ãƒ¼ãƒ‰UTF8ã®Dataå‹ã«å¤‰æ›
+ print(String(data: jsonData , encoding: .utf8)!)
```

ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ä»¥ä¸‹ã®JSONå½¢å¼ã®ã‚³ãƒ¼ãƒ‰ãŒå‡ºåŠ›ã•ã‚Œã‚‹

```json:å‡ºåŠ›
{
  "name" : "Ame",
  "age" : 21,
  "hobby" : "Watch TV"
}
```

ã“ã“ã¾ã§ã¯ã‚ˆãã‚ã‚‹ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã®è©±ã€‚

æ¬¡ã«ã€`age`ã¨`hobby`ã«`nil`ã‚’å…¥ã‚Œã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã¦ã¿ã‚‹ã€‚

```diff_swift:SampleEncode.swif
import Foundation

struct Person: Codable {
    var name:String
    var age:Int?
    var hobby:String?
}

- let person = Person(name: "Ame", age: 21, hobby: "Watch TV")
+ let person = Person(name: "Ame", age: nil, hobby: nil)

let encoder = JSONEncoder()

// ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’æŒ‡å®š
encoder.outputFormatting = .prettyPrinted

// ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
let jsonData = try encoder.encode(person)

// æ–‡å­—ã‚³ãƒ¼ãƒ‰UTF8ã®Dataå‹ã«å¤‰æ›
print(String(data: jsonData , encoding: .utf8)!)
```

ã“ã“ã§ã€ç†æƒ³çš„ãªå‡ºåŠ›ã¯ã€

```json:ç†æƒ³çš„ãªå‡ºåŠ›
{
  "name" : "Ame",
  "age" : null,
  "hobby" : null
}
```
ã§ã‚ã‚‹ã€‚ã—ã‹ã—å®Ÿè¡Œã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å‡ºåŠ›ã•ã‚Œã‚‹ã€‚

```json:å®Ÿéš›ã®å‡ºåŠ›
{
  "name" : "Ame"
}
```

ã“ã®ã‚ˆã†ã«ã€`nil`ã‚’å…¥ã‚ŒãŸç®‡æ‰€ã ã‘ç©ºç™½ã§å‡ºåŠ›ã•ã‚Œã‚‹ã€‚

ã“ã®å®Ÿéš›ã®å‡ºåŠ›ã‚’ã©ã†ã«ã‹ã—ã¦ç†æƒ³çš„ãªå‡ºåŠ›ã®å½¢ã«ã—ãŸã„ã¨ã„ã†ã®ãŒä»Šå›ã®è¨˜äº‹ã®ç›®çš„ã§ã‚ã‚‹ã€‚

# æœ¬è«–
ã‚ãˆã¦ã„ããªã‚Šçµè«–ã‚’è¨€ã†ã¨ã€`JSONEncoder`ãŒã‚­ãƒ¼ã‚’ä¿æŒã—ã€`null`ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹æ–¹æ³•ã—ã‹ãªã„ã€‚

è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸã‚‚ã®ã¯ä½¿ãˆãªã„ãŸã‚ã€è‡ªåˆ†ã§`encode(to:)`ã®å®Ÿè£…ã‚’æ›¸ãå¿…è¦ãŒã‚ã‚‹ã€‚

æ˜ç¤ºçš„ã«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å†…ã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å‡¦ç†ã•ã›ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã«ãªã‚‹ã€‚

```diff_swift:SampleEncode.swift

import Foundation

struct Person: Codable {
    var name:String
    var age:Int?
    var hobby:String?

+    func encode(to encoder: Encoder) throws {
+        var container = encoder.container(keyedBy: CodingKeys.self)
+        try container.encode(name, forKey: .name)
+        try container.encode(age, forKey: .age)
+        try container.encode(hobby, forKey: .hobby)
+    }
}

let person = Person(name: "Ame", age: nil, hobby: nil)

let encoder = JSONEncoder()

// ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’æŒ‡å®š
encoder.outputFormatting = .prettyPrinted

// ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
let jsonData = try encoder.encode(person)

// æ–‡å­—ã‚³ãƒ¼ãƒ‰UTF8ã®Dataå‹ã«å¤‰æ›
print(String(data: jsonData , encoding: .utf8)!)
```

```json:å‡ºåŠ›çµæœ
{
  "name" : "Ame",
  "age" : null,
  "hobby" : null
}
```

ã—ã‹ã—ã€ã“ã‚Œã ã¨ä»–ã®ç®‡æ‰€ã§ã‚‚åŒã˜å†…å®¹ã®ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã«ãªã‚Šã€ä¸ä¾¿ãªã®ã§ã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’ä½œæˆã—ãŸæ–¹ãŒä¾¿åˆ©ãã†ã§ã¯ã‚ã‚‹ã€‚

ã‚ˆã£ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã™ã‚‹ã€‚(ãŸã ã—ã€Swift5.1ä»¥ä¸ŠãŒå¿…è¦)

```swift:EncodeProperty.swift
@propertyWrapper
struct NullEncodable<T>: Encodable where T: Encodable {
    
    var wrappedValue: T?

    init(wrappedValue: T?) {
        self.wrappedValue = wrappedValue
    }
    
    func encode(to encoder: Encoder) throws {
        var container = encoder.singleValueContainer()
        switch wrappedValue {
        case .some(let value): try container.encode(value)
        case .none: try container.encodeNil()
        }
    }
}
```

ã‚³ãƒ¼ãƒ‰ã¯æ¯”è¼ƒçš„å˜ç´”ã§ã€ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ã™ã‚‹å€¤ãŒã‚ã‚Œã°ãã®ã¾ã¾ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã€ãªã‘ã‚Œã°`Null`å€¤ã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦ã„ã‚‹ã€‚

## ä½¿ã„æ–¹
ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãƒ©ãƒƒãƒ—ã•ã‚ŒãŸæ§‹é€ ä½“ã¯ã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ç›´å‰ã«å±æ€§ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚ä»Šå›ã¯`@NullEncodable`ã‚’`Null`å€¤ãŒå¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£(`age`, `hobby`)ã®ç›´å‰ã«æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

```diff_swift:SampleEncode.swif
import Foundation

struct Person: Codable {
    var name:String
-    var age:Int?
-    var hobby:String?
+   @NullEncoda var age:Int?
+   @NullEncoda var hobby:String?
}

+@propertyWrapper
+struct NullEncodable<T>: Encodable where T: Encodable {
+    
+    var wrappedValue: T?
+
+    init(wrappedValue: T?) {
+        self.wrappedValue = wrappedValue
+    }
+    
+    func encode(to encoder: Encoder) throws {
+        var container = encoder.singleValueContainer()
+        switch wrappedValue {
+        case .some(let value): try container.encode(value)
+        case .none: try container.encodeNil()
+        }
+    }
+}


 let person = Person(name: "Ame", age: nil, hobby: nil)

let encoder = JSONEncoder()

// ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’æŒ‡å®š
encoder.outputFormatting = .prettyPrinted

// ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
let jsonData = try encoder.encode(person)

// æ–‡å­—ã‚³ãƒ¼ãƒ‰UTF8ã®Dataå‹ã«å¤‰æ›
print(String(data: jsonData , encoding: .utf8)!)
```

```json:å‡ºåŠ›
{
  "name" : "Ame",
  "age" : null,
  "hobby" : null
}
```

ã“ã‚Œã§ç†æƒ³çš„ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã“ã¨ãŒã§ããŸã€‚

# ç™ºç”Ÿã—ãŸåŸå› 
å®Œç’§ãªè§£ç­”ã‚’çªãæ­¢ã‚ã‚‹ã“ã¨ã¯ã§ããªã‹ã£ãŸã€‚

çŸ¥ã£ã¦ã„ã‚‹äººãŒã„ãŸã‚‰æ•™ãˆã¦æ¬²ã—ã„ğŸ’¦

ãŠãã‚‰ãã€JSONEncoderã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹å€¤ã«nilã¯å«ã¾ã‚Œã¦ã„ãªã„ã‚ˆã†ã§ã‚ã‚‹ã€‚

Xcodeã‹ã‚‰ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã“ã¨ãŒæ›¸ã‹ã‚Œã¦ã„ãŸã€‚

```swift
    /// Encodes the given top-level value and returns its JSON representation.
    ///
    /// - parameter value: The value to encode.
    /// - returns: A new `Data` value containing the encoded JSON data.
    /// - throws: `EncodingError.invalidValue` if a non-conforming floating-point value is encountered during encoding, and the encoding strategy is `.throw`.
    /// - throws: An error if any value throws an error during encoding.
    open func encode<T>(_ value: T) throws -> Data where T : Encodable
``` 
ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹å€¤â†’JSONãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚€æ–°ã—ã„`Data`å€¤ã‚’è¿”ã™ã®ã ãŒã€ã“ã®`Data`å€¤ã«`nil`å€¤ã¯å«ã¾ã‚Œã¦ã„ãªã„ãŸã‚ã€éè¡¨ç¤ºã•ã‚Œã¦ã—ã¾ã†ã‚ˆã†ã§ã‚ã‚‹ã€‚

# å‚è€ƒæ–‡çŒ®

https://stackoverflow.com/questions/47266862/encode-nil-value-as-null-with-jsonencoder


https://yagamo-style.com/2022/03/12/json-with-null-value/